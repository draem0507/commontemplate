<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=gb2312" />
		<title>Common Template Engine</title>
		<meta name="keywords" content="commontemplate ctl template language engine code generator" />
		<style type="text/css">
			body {
				margin: 0px;
				padding: 0px;
				font-family: Arial, Helvetica, sans-serif;
				font-size: 12px;
				color: #000000;
				cursor: url('../images/cursor.cur');
			}
			
			td {
				font-size: 12px;
				height: 26;
			}
			
			img {
				border: 0px;
				clear: right;
			}
			
			input {
				font-family: Arial, Helvetica, sans-serif;
				font-size: 12px;
				color: #000000;
			}
			
			a:link {
				font-size: 12px;
				color: #003399;
				text-decoration: none;
			}
			a:visited {
				font-size: 12px;
				color: #003399;
				text-decoration: none;
			}
			a:active {
				font-size: 12px;
				color: #003399;
				text-decoration: none;
			}
			a:hover {
				font-size: 12px;
				color: #003399;
				text-decoration: underline;
			}
		</style>
	</head>
	<body>
		<table width="100%" border="0" cellspacing="0" cellpadding="0">
			<tr>
				<td colspan="2" rowspan="2" height="60">
					<a href="http://www.commontemplate.org"><img src="../images/banner.gif" alt="Common Template Engine" border="0" width="400" height="50" /></a>
				</td>
				<td valign="top" align="right">
					<a href="../en/architecture_guide.html">English</a> | 中文 | <a href="join.html">翻译</a>&nbsp;&nbsp;
				</td>
			</tr>
			<tr>
				<td valign="bottom" align="right">
					<table border="1" cellpadding="0" cellspacing="0" height="22" style="border-collapse: collapse; border-style: solid; border-color: #CCCCCC; font-weight: bold;">
						<tr align="center">
							<td width="90"><a href="download.html">下载</a></td>
							<td width="90"><a href="news.html">新闻</a></td>
							<td width="90"><a target="_blank" href="http://forum.commontemplate.org/">论坛</a></td>
							<td width="90"><a href="about.html">关于我们</a></td>
						</tr>
					</table>
				</td>
			</tr>
			<tr>
				<td colspan="3" height="6" style="background-color: #005B88;"></td>
			</tr>
			<tr>
				<td colspan="3" height="6"></td>
			</tr>
			<tr>
				<td width="20%" height="600" valign="top">
					<table border="1" style="border-collapse:collapse; table-layout:fixed; word-wrap:beak-word;" cellspacing="1" cellpadding="2">
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="4" height="22" style="background-color: #0055CC;"></td>
										<td width="4"></td>
										<td style="font-weight: bold;">文档</td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="index.html">概览</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="template_guide.html">模板指南</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="expression_guide.html">表达式指南</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="integration_guide.html">集成指南</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="config_guide.html">配置指南</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="use_guide.html">使用指南</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="expansibility_guide.html">扩展指南</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="architecture_guide.html">架构指南</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="faq.html">常见问题</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="4" height="22" style="background-color: #0055CC;"></td>
										<td width="4"></td>
										<td style="font-weight: bold;">下载</td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="download.html">发行版本</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="svn.html">SVN</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="example.html">使用范例</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="editor.html">编辑器插件</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="4" height="22" style="background-color: #0055CC;"></td>
										<td width="4"></td>
										<td style="font-weight: bold;">资源</td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="../resource/license.txt" target="_blank">许可协议</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="#">更新日志</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="../resource/commontemplate.properties" target="_blank">配置文件</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="uml.html">UML</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a target="_blank" href="../javadoc/index.html">Java Doc</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="#">测试报告</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="4" height="22" style="background-color: #0055CC;"></td>
										<td width="4"></td>
										<td style="font-weight: bold;">社区</td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a target="_blank" href="http://forum.commontemplate.org/">论坛</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a target="_blank" href="http://sourceforge.net/mail/?group_id=193256">邮件列表</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a target="_blank" href="http://sourceforge.net/tracker/?group_id=193256&atid=944685">问题列表</a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a target="_blank" href="http://sourceforge.net/tracker/?func=add&group_id=193256&atid=944685" style="color: #FF5555;"><b>点这里报告问题 !<b></a></td>
									</tr>
								</table>
							</td>
						</tr>

						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="4" height="22" style="background-color: #0055CC;"></td>
										<td width="4"></td>
										<td style="font-weight: bold;">支持</td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a target="_blank" href="http://sourceforge.net" target="_blank"><img src="../images/sourceforge.jpg" border="0" /></a></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td height="24" style="background-color: #F4F4F4;">
								<table width="100%" border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td width="16"></td>
										<td><a href="http://www.commontemplate.org" target="_blank"><img src="../images/logo.gif" border="0" /></a></td>
									</tr>
								</table>
							</td>
						</tr>
					</table>
				</td>
				<td colspan="2" width="80%" align="center" valign="top">
					<table width="90%" border="0" cellpadding="0" cellspacing="0">
						<tr>
							<td height="32" align="left"><b><font size="3">CommonTemplate 架构指南</font></b></td>
						<tr>
						<tr>
							<td align="left"><hr width="30%"></td>
						<tr>
						<tr>
							<td align="left">
								<br/>
								<b>一. 包结构设计说明</b><br/>
								<b>设计原则：</b><br/>
								<b>高内聚：</b><br/>
								重用发布等价原则(REP)： 包的重用粒度应该与可发布粒度相同，可发布是指可单独打成组件包(jar)，并且组件包能符合开闭原则(OCP)。<br/>
								共同重用原则(CRP)： 包中的类应该有同样的重用可能性，也就是紧密协作的类应该放在一个包。<br/>
								共同封闭原则(CCP)： 包中所有类应该对同一类性质的改变作出相同反应(全改或全不改)，若改动则变化应在包内终止而不传播到其它包。<br/>
								<b>低耦合：</b><br/>
								无环依赖原则(ADP)： 包之间不出现相互依赖和循环依赖，这是最基本应做到的。<br/>
								稳定依赖原则(SDP)： 被依赖的包应该总是比依赖者更稳定，也就是不要让一个稳定的包依赖于不稳定包。<br/>
								稳定抽象原则(SAP)： 越稳定的包应该越抽象。 <font color="green">(注：参见此节后面的计算方式)</font><br/>
								<br/>
								<b>CommonTemplate总体包结构：</b><br/>
								<b>(0) util包 (通用工具包)</b><br/>
								<font color="gray">位置：</font>org.commontemplate.util及其子包<br/>
								<font color="gray">职责定义：</font>相当于java.util的扩展，实现一些其它通用功能，它只依赖于JDK，不依赖于CommonTemplate引擎。<br/>
								<font color="green">(注：以下包都依赖于JDK相关包及上面的util包，不再说明)</font><br/>
								<b>(1) core包 (核心API包)</b><br/>
								<font color="gray">位置：</font>org.commontemplate.core及其子包<br/>
								<font color="gray">职责定义：</font>模板语言的API包，定义模板各元素间的关系，资源管理接口等，全部为接口或抽象类，围绕Template和Context展开。<br/>
								<font color="gray">入口类：</font>org.commontemplate.core.Factory<br/>
								<b>(2) engine包 (引擎实现包)</b><br/>
								<font color="gray">位置：</font>org.commontemplate.engine及其子包<br/>
								<font color="gray">职责定义：</font>模板引擎的实现，处理模板加载解析等，实现core包的所有接口，此包隐藏实现细节，只暴露Engine类，便于后期优化，Engine实现了core包的Factory，core包的其它相关接口都可以通过接口间导航获取。<br/>
								<font color="gray">依赖于：</font>core包, config包<br/>
								<font color="gray">入口类：</font>org.commontemplate.engine.Engine<br/>
								<b>(3) config包 (配置SPI包)</b><br/>
								<font color="gray">位置：</font>org.commontemplate.config及其子包<br/>
								<font color="gray">职责定义：</font>留给第三方的扩展接口，以Configuration接口为中心，Configuration定义了engine包所需配置的getXXX()方法，但不包括setXXX()等，因为SPI不应限制实现类的注册方式。<br/>
								<font color="gray">依赖于：</font>core包<br/>
								<font color="gray">入口类：</font>org.commontemplate.config.Configuration<br/>
								<b>(4) standard包 (标准参考配置实现包)</b><br/>
								<font color="gray">位置：</font>org.commontemplate.standard及其子包<br/>
								<font color="gray">职责定义：</font>config包的标准参考实现，包括指令及操作符等语法的定义相关配置，并提供Configuration相应的setXXX, addXXX等注册方法类。<br/>
								<font color="gray">依赖于：</font>core包, config包<br/>
								<font color="gray">入口类：</font>org.commontemplate.standard.ConfigurationSettings<br/>
								<b>(5) ext包 (扩展配置实现包)</b><br/>
								<font color="gray">位置：</font>org.commontemplate.ext及其子包<br/>
								<font color="gray">职责定义：</font>config包的第三方适配实现等。<br/>
								<font color="gray">依赖于：</font>core包, config包, standard包<br/>
								<b>(6) tools包 (Client使用工具包)</b><br/>
								<font color="gray">位置：</font>org.commontemplate.tools及其子包<br/>
								<font color="gray">职责定义：</font>一些常用的客户端工具以及与其它框架集成相关类，这些已不属于CommonTemplate引擎的范围内，只是为了方便用户使用而提供。<br/>
								<font color="gray">依赖于：</font>core包, engine包, config包, standard包<br/>
								<font color="gray">入口类：</font>org.commontemplate.standard.PropertiesConfigurationLoader<br/>
								<br/>
								<b>总体包结构图如下：</b> <font color="green">(注：隐抑了继承包相同于被继承包的依赖关系)</font><br/>
								<img src="../images/uml/package.gif"/><br/>
								<br/>
								<b>不稳定度与抽象度的计算与关系：</b><br/>
								<b>(1) I = Ce / (Ca + Ce)</b><br/>
								I: Instability (不稳定度)<br/>
								Ca: Afferent Coupling (传入依赖，也就是被其它包依赖的个数)<br/>
								Ce: Efferent Coupling (输出依赖，也就是依赖其它包的个数)<br/>
								<b>(2) A = Na / Nc</b><br/>
								A: Abstractness (抽象度)<br/>
								Na: Number of abstract classes (抽象类的个数)<br/>
								Nc: Number of classes (类的个数，包括抽象类)<br/>
								<b>(3) D = abs(1 - I - A) * sin(45)</b><br/>
								D: Distance (偏差)<br/>
								I: Instability (不稳定度)<br/>
								A: Abstractness (抽象度)<br/>
								<img src="../images/frame/iad.gif" /><br/>
								设计最理想状态是D为0，也就是I-A交点分布在绿线上<br/>
								比较合理的设计度量为：D &lt; 0.2<br/>
								<br/>
								<b>CommonTemplate所有包(包括子包)的I-A交点分布如下：</b> <font color="green">(注：D &lt; 0.2 的为绿色，否则为黑色)</font><br/>
								<img src="../images/frame/metrics.gif" /><br/>
								黑色(不合格)的是：<br/>
								util包 (这个包必然如此，因为作为工具包，它被依赖过多，但抽象度却不够)<br/>
								standard包的一些子包 (待调整)<br/>
								<br/>
								<b>二. 核心包设计说明</b><br/>
								核心包采用接口驱动设计，全部为接口或抽象类，只考虑需求与关系，忽略实现。<br/>
								并按领域驱动设计将其分为三个域：<br/>
								<b>(1) Template域</b> (实体域)<br/>
								<font color="gray">范围：</font>包括Resource, Template, Element, Directive, Expression, Operator等。<br/>
								<font color="gray">职责定义：</font>用于表示一个具体的模板，此域是整个引擎的中心，所有功能围绕其展开。<br/>
								<font color="gray">线程安全性：</font>Template域的领域模型被设计成线程安全的(不变类)，保证在多线程中单实例重用。<br/>
								<b>(2) Context域</b> (会话域)<br/>
								<font color="gray">范围：</font>包括Context, GlobalContext, LocalContext等。<br/>
								<font color="gray">职责定义：</font>Context域负责状态及外部资源的管理。<br/>
								<font color="gray">线程安全性：</font>Context域是非线程安全，应该为每次执行创建新的实例(即在线程栈内使用)。<br/>
								<b>(3) Factory域</b> (服务域)<br/>
								<font color="gray">范围：</font>包括Factory, ContextFactory, TemplateFactory等。<br/>
								<font color="gray">职责定义：</font>Factory域负责管理Template域和Context域的生命周期。<br/>
								<font color="gray">线程安全性：</font>Factory域是线程安全的(内部同步)，可单例重用。<br/>
								<b>核心包设计图如下：</b> <font color="green">(注：省略了Element对Context和Expression对VariableResolver的依赖关系)</font><br/>
								<img src="../images/uml/core.gif" /><br/>
								四色原型概要[Coad95-97]<br/>
								红色：moment-interval (瞬时状态，会话)<br/>
								黄色：role (主动域，操作者，服务等)<br/>
								绿色：party, place or thing (被动域，实体，值对象等)<br/>
								蓝色：catalog-entry-like description (分类或入口标识)<br/>
								<br/>
								<b>三. 引擎包设计说明</b><br/>
								引擎包使用配置包SPI实现核心包API。<br/>
								引擎包隐藏所有实现细节，只暴露Engine, TemplateEngine, ExpressionEngine，便于后期优化。<br/>
								引擎按重用粒度分级控制：<br/>
								(1) 通常都直接用Engine，它提供所有功能，包括解析器和Context资源管理等。<br/>
								(2) 如果使用第三方实现的Context(通常用在与其它模板工具适配时)，则可以只用TemplateEngine，提供模板解析功能。<br/>
								(3) 如果只用表达式功能(通常是作为动态表达式求值工具时)，则可以只用ExpressionEnine，提供表达式解析功能。<br/>
								<b>引擎包设计图如下：</b><br/>
								<img src="../images/uml/engine.gif" border="0"/><br/>
								<br/>
								<b>四. 配置包设计说明</b><br/>
								配置包用于向引擎供给数据，按引擎包的格局分三个层次：<br/>
								(1) 表达式解析配置<br/>
								(2) 模板解析配置<br/>
								(3) 资源管理配置<br/>
								<b>配置包设计图如下：</b><br/>
								<img src="../images/uml/config.gif"/><br/>
								<br/>
							</td>
						<tr>
					</table>
				</td>
			</tr>
			<tr>
				<td colspan="3" height="6" align="center"><hr width="94%"/></td>
			</tr>
			<tr>
				<td colspan="3" height="24" align="center">
					<table border="0" cellpadding="0" cellspacing="0">
						<tr>
							<td>
								版权所有 &#169; 2007-2008 <a href="about.html">CommonTemplate开发小组</a>
							</td>
							<td width="20">
								&nbsp;
							</td>
							<td>
								<a href="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd" target="_blank"><img src="../images/w3c_xhtml.gif" border="0" /></a>
							</td>
							<td>
								<a href="http://www.w3.org/Style/CSS/" target="_blank"><img src="../images/w3c_css.gif" border="0" /></a>
							</td>
						<tr>
					</table>
				</td>
			</tr>
		</table>
	</body>
</html>